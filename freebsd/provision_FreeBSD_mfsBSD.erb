<%#
kind: provision
name: FreeBSD (mfsBSD) provision
oses:
- FreeBSD 10.0
%>
<%
proxy_string = @host.params['http-proxy'] ? "http://#{@host.params['http-proxy']}:#{@host.params['http-proxy-port']}" : ''
%>
export http_proxy='<%= proxy_string %>'

# Get the disk layout, and the first disk connected to the system
disk_layout=`/sbin/sysctl -n kern.disks | /usr/bin/sed 's/cd[0-9]//g'`
first_disk=`echo ${disk_layout##*[1-9]} | /usr/bin/cut -d' ' -f1`

/root/bin/destroygeom -d <%= @host.params['install-disk'] || '$first_disk' %> || exit 1

export TERM=xterm
export DISTRIBUTIONS="kernel.txz base.txz"
export BSDINSTALL_DISTDIR=/tmp
export BSDINSTALL_DISTSITE=<%= @mediapath %>

cat > /tmp/installerconfig << EOF
PARTITIONS=<%= @host.params['install-disk'] || '$first_disk' %>
DISTRIBUTIONS="kernel.txz base.txz"
BSDINSTALL_DISTDIR=/tmp
BSDINSTALL_DISTSITE=<%= @mediapath %>

#!/bin/sh
fetch -q --no-verify-hostname --no-verify-peer -o /tmp/finish.sh -d <%= foreman_url('finish') %>
/bin/sh /tmp/finish.sh
rm /tmp/finish.sh

fetch -q --no-verify-hostname --no-verify-peer -o /dev/null -d <%= foreman_url %>
EOF

bsdinstall distfetch
bsdinstall script /tmp/installerconfig
sleep 5
reboot
